# Technical Context

## 技术选型

| 决策 | 选择 | 理由 |
|------|------|------|
| AI 服务 | aihubmix + gpt-4o-mini | 用户指定，成本低 |
| API 地址 | https://aihubmix.com/v1 | 用户确认 |
| 对话存储 | 文件系统 JSON | 简单可靠，重启不丢 |
| 分段策略 | AI 智能分割 + 失败重试 | 自然断句，效果好 |
| 消息合并 | 防抖 5 秒 | 等用户发完再处理 |
| 并发控制 | 队列序列化 | 每个用户一个队列，避免文件冲突 |

## 行为决策（评审确认）

| 场景 | 行为 | 理由 |
|------|------|------|
| 等待合并期间 | 无反馈 | 简化实现 |
| AI 分段失败 | 重试一次 | 保证分段质量 |
| 用户打断回复 | 发完当前再处理新消息 | 避免对话混乱 |
| 历史裁剪 | 按轮数（20 轮） | 简单有效 |

## Tradeoffs

| 取舍 | 接受的代价 | 获得的收益 |
|------|------------|------------|
| 用 AI 分段而非规则 | 额外 API 调用成本 | 分段更自然 |
| 文件存储而非数据库 | 无法跨服务器共享 | 简单，无依赖 |
| 5 秒合并等待 | 响应稍慢 | 理解完整意图 |
| 队列序列化 | 单用户串行处理 | 避免并发问题 |

## 关键配置（可调）

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| MESSAGE_MERGE_TIMEOUT | 5000ms | 消息合并等待时间 |
| MAX_HISTORY_LENGTH | 20 | 保留最近 N 轮对话 |
| LONG_TEXT_THRESHOLD | 200字 | 超过则触发分段 |
| TYPING_PER_CHAR | 50ms | 每字符的 typing 时间 |
| SPLIT_RETRY_COUNT | 1 | 分段失败重试次数 |

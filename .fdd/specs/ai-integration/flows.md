# Core Flows

## 文字消息处理流程

```
收到文字 → 加入消息队列 → 等待 5s
→ 合并队列中的消息 → 附加对话历史
→ 调用 AI → 检查回复长度
→ [长] 调用 AI 分段 → 逐条发送（智能延迟）
→ [短] 直接发送
→ 保存到对话历史
```

## 智能延迟流程

```
收到消息 → 初始延迟(1-5s)
→ 标记已读(延迟与输入长度相关)
→ 思考延迟(模拟阅读时间)
→ typing 状态(与输出长度相关)
→ 发送
```

## 分段发送流程（每段）

```
发送第 N 段 → typing(根据本段字数)
→ 发送 → 等待(根据下段字数) → 下一段
```

## 对话历史管理

```
新消息 → 加载历史文件 → 追加消息
→ 检查长度 → [超限] 裁剪旧消息
→ 保存回文件
```
